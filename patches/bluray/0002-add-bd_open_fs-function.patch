From 9777015ccd549001704ca5fc6ba31f1f3c360a87 Mon Sep 17 00:00:00 2001
From: qianlongxu <qianlongxu@gmail.com>
Date: Wed, 25 Sep 2024 10:48:01 +0800
Subject: [PATCH 2] add bd_open_fs function

---
 src/libbluray/bluray.c | 23 +++++++++++++++++++++++
 src/libbluray/bluray.h | 15 ++++++++++++++-
 2 files changed, 37 insertions(+), 1 deletion(-)

diff --git a/src/libbluray/bluray.c b/src/libbluray/bluray.c
index e9ff566..8036d29 100644
--- a/src/libbluray/bluray.c
+++ b/src/libbluray/bluray.c
@@ -1597,6 +1597,29 @@ BLURAY *bd_open(const char *device_path, const char *keyfile_path)
     return bd;
 }
 
+BLURAY *bd_open_fs(const char *device_path, const char *keyfile_path, fs_access *p_fs)
+{
+    BLURAY *bd;
+
+    bd = bd_init();
+    if (!bd) {
+        return NULL;
+    }
+
+    if (!device_path) {
+        BD_DEBUG(DBG_BLURAY | DBG_CRIT, "No device path provided!\n");
+        bd_close(bd);
+        return NULL;
+    }
+
+    if (!_bd_open(bd, device_path, keyfile_path, p_fs)) {
+        bd_close(bd);
+        return NULL;
+    }
+
+    return bd;
+}
+
 void bd_close(BLURAY *bd)
 {
     if (!bd) {
diff --git a/src/libbluray/bluray.h b/src/libbluray/bluray.h
index 756520e..040150a 100644
--- a/src/libbluray/bluray.h
+++ b/src/libbluray/bluray.h
@@ -331,7 +331,7 @@ void bd_get_version(int *major, int *minor, int *micro);
 struct bd_dir_s;
 struct bd_file_s;
 struct meta_dl;
-
+struct fs_access;
 /**
  *  Open BluRay disc
  *
@@ -343,6 +343,19 @@ struct meta_dl;
  */
 BLURAY *bd_open(const char *device_path, const char *keyfile_path);
 
+/**
+ *  Open BluRay disc
+ *
+ *  Shortcut for bd_open_disc(bd_init(), device_path, keyfile_path)
+ *
+ * @param device_path   path to mounted Blu-ray disc, device or image file
+ * @param keyfile_path  path to KEYDB.cfg (may be NULL)
+ * @param p_fs          custom access io
+ * @return allocated BLURAY object, NULL if error
+ */
+
+BLURAY *bd_open_fs(const char *device_path, const char *keyfile_path, struct fs_access *p_fs);
+
 /**
  *  Initialize BLURAY object
  *
-- 
2.39.3 (Apple Git-146)

